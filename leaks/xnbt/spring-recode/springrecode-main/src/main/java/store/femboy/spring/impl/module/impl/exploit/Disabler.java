package store.femboy.spring.impl.module.impl.exploit;

import best.azura.eventbus.core.EventPriority;
import best.azura.eventbus.handler.EventHandler;
import best.azura.eventbus.handler.Listener;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.*;
import org.lwjgl.input.Keyboard;
import store.femboy.spring.impl.event.impl.EventGetPacket;
import store.femboy.spring.impl.event.impl.EventSendPacket;
import store.femboy.spring.impl.module.Category;
import store.femboy.spring.impl.module.Module;
import store.femboy.spring.impl.module.settings.impl.ModeSetting;
import store.femboy.spring.impl.util.*;

import java.util.Queue;
import java.util.concurrent.ConcurrentLinkedQueue;

public final class Disabler extends Module {

    ModeSetting modes = new ModeSetting("Modes", "Hypixel", "Verus", "HazelMC", "ViperMC", "Hypixel", "Buzz");

    public Disabler() {
        super("Disabler", "funny!", Keyboard.KEY_Y, Category.EXPLOIT);
        addSettings(modes);
    }

    private final Queue<Packet> packetQueue = new ConcurrentLinkedQueue();
    private final Queue<Packet<?>> concurrentLinkedQueue = new ConcurrentLinkedQueue<>();
    private boolean handleTeleport;

    TimeUtil timer = new TimeUtil();

    @Override
    public void onEnable() {
        super.onEnable();
    }

    @Override
    public void onDisable() {
        super.onDisable();
    }

    @EventHandler(EventPriority.DEFAULT)
    public final Listener<EventSendPacket> onSendPacket = e -> {

        switch(modes.getMode()){
            case "HazelMC":
                if(e.getPacket() instanceof C03PacketPlayer){
                    C03PacketPlayer c03 = (C03PacketPlayer) e.getPacket();
                    if(mc.thePlayer.ticksExisted % 25 == 0){
                        c03.y = -1.161;
                        c03.onGround = false;
                        c03.setMoving(false);
                    }
                    if(mc.thePlayer != null && mc.thePlayer.ticksExisted <=1){
                        timer.reset();
                        packetQueue.clear();
                    }
                }
                if(e.getPacket() instanceof C0BPacketEntityAction)
                    e.setCancelled(true);

                if(e.getPacket() instanceof C0FPacketConfirmTransaction){
                    PacketSleepThread.delayPacket(e.getPacket(), 140L);
                    e.setCancelled(true);
                }

                if(e.getPacket() instanceof C00PacketKeepAlive){
                    PacketSleepThread.delayPacket(e.getPacket(), 140L);
                    e.setCancelled(true);
                }

               break;
            case "Verus":
                if(e.getPacket() instanceof C0FPacketConfirmTransaction){
                    C0FPacketConfirmTransaction c0f = (C0FPacketConfirmTransaction) e.getPacket();
                    packetQueue.add(c0f);
                    e.setCancelled(true);
                }
                if(e.getPacket() instanceof C03PacketPlayer){
                    C03PacketPlayer c03 = (C03PacketPlayer) e.getPacket();
                    if(mc.thePlayer.ticksExisted % 25 == 0){
                        c03.y = 0.0420697279974;
                        c03.onGround = false;
                    }
                }
                break;
            case "Hypixel":
                C0BPacketEntityAction packet = (C0BPacketEntityAction) e.getPacket();
                C0BPacketEntityAction.Action action = packet.getAction();
                if (action == C0BPacketEntityAction.Action.START_SPRINTING || action == C0BPacketEntityAction.Action.STOP_SPRINTING) {
                    e.setCancelled(true);
                }
                if(mc.thePlayer.ticksExisted < 100 && (e.getPacket() instanceof C03PacketPlayer.C05PacketPlayerLook || e.getPacket() instanceof C03PacketPlayer.C06PacketPlayerPosLook || e.getPacket() instanceof C03PacketPlayer.C04PacketPlayerPosition)) {
                    e.setCancelled(true);
                }
                if(!MoveUtil.isMoving()){
                    if(e.getPacket() instanceof C03PacketPlayer || e.getPacket() instanceof C03PacketPlayer.C04PacketPlayerPosition || e.getPacket() instanceof C03PacketPlayer.C05PacketPlayerLook || e.getPacket() instanceof C03PacketPlayer.C06PacketPlayerPosLook){
                        e.setCancelled(true);
                    }
                }
                break;
        }
    };

    @EventHandler(EventPriority.DEFAULT)
    public final Listener<EventGetPacket> onGetPacket = e ->{

        switch(modes.getMode()){
            case "Verus":
                if(mc.thePlayer.ticksExisted % MathUtil.getRandInt(33, 35) == 0 && e.isPre()) {
                    if (!packetQueue.isEmpty()) {
                        PacketUtil.sendSilentPacket(packetQueue.poll());
                    }
                }
                if(timer.hasTimeElapsed(16660L)){
                    while (!packetQueue.isEmpty()){
                        PacketUtil.sendSilentPacket(packetQueue.poll());
                    }
                    PacketUtil.sendSilentPacket(new C03PacketPlayer.C04PacketPlayerPosition());
                    timer.reset();
                }
                break;
            case "Hypixel":
                break;
        }

    };
}
